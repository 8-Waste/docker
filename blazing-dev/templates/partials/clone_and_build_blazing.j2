{# This partial clones the BlazingSQL repo and build and installs it into the rapids conda env. #}

{# Install build prerequisites #}
RUN gpuci_conda_retry install -y -n rapids \
        google-cloud-cpp=1.16.0 \
        ninja \
        gtest \
        gmock \
        cppzmq \
        openjdk=8.0 \
        maven \
        thrift=0.13.0 \
        jpype1 \
        netifaces \
        pyhive \
        nlohmann_json \
        arrow-cpp

ENV CUDF_HOME=/rapids/cudf

# Clone, build, install. Note: This uses the current default branch instead of main.
RUN mkdir -p ${BLAZING_DIR} \
    && cd ${BLAZING_DIR} \
    && git clone https://github.com/BlazingDB/blazingsql.git

# Add additional CUDA lib dir to LD_LIBRARY_PATH for "docker build".  This is
# not needed when using the nvidia runtime with "docker run" since the nvidia
# runtime also installs libcuda to a system location that client builds often
# find.
ARG CUDA_VER
ENV LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/cuda/compat

RUN source activate rapids \
    && ccache -s \
    && cd ${BLAZING_DIR}/blazingsql \
    && ./build.sh
