RUN source activate rapids \
    && env \
    && pip install sphinx-markdown-tables \
    && conda list \
    # FIXME: Base image should have correct blas version and blas uninstall/install here
    #        should be removed
    && conda uninstall -y blas openblas \
    && conda install -y -n rapids --freeze-installed --override-channels \
      -c rapidsai \
      -c rapidsai-nightly \
      -c nvidia \
      -c ${XGBOOST_CONDA_LABEL} \
      -c conda-forge \
      -c anaconda \
      boost-cpp=${BOOST_CPP_VERSION} \
      cmake=${CMAKE_VERSION} \
      cmake_setuptools">=0.1.3" \
      rapidsai::cupy \
      double-conversion \
      dlpack \
      flatbuffers \
      hypothesis \
      rapidsai::libclang \
      libcumlprims \
      libcypher-parser \
      libgfortran-ng=${LIBGFORTRAN_NG_VERSION} \
      lapack \
      liblapack \
      make \
      numba">=${NUMBA_VERSION}" \
      numpy=${NUMPY_VERSION} \
      pandas=${PANDAS_VERSION} \
      pytest \
      rapidjson \
      conda-forge::blas==1.1=openblas \
      sphinx sphinx_rtd_theme numpydoc sphinxcontrib-websupport nbsphinx recommonmark doxygen "pandoc<=2.0.0" \
    && conda clean -afy \
    && chmod -R ugo+w /opt/conda

# Special case: libcumlmg is not available for CUDA 9.2
RUN if [ "${CUDA_MAJORMINOR_VERSION}" != "9.2" ]; then conda install -y --no-deps -c nvidia -c conda-forge libcumlmg && conda clean -afy; fi
